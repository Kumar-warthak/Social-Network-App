import requests
import msal

# Step 1: App Credentials
tenant_id = "YOUR_TENANT_ID"
client_id = "YOUR_CLIENT_ID"
client_secret = "YOUR_CLIENT_SECRET"
authority = f"https://login.microsoftonline.com/{tenant_id}"
scope = ["https://graph.microsoft.com/.default"]

# Step 2: SharePoint Site Info
site_hostname = "contoso.sharepoint.com"
site_path = "/sites/TestSite"  # change as needed

# Step 3: Get access token
app = msal.ConfidentialClientApplication(
    client_id, authority=authority, client_credential=client_secret
)
token_response = app.acquire_token_for_client(scopes=scope)
access_token = token_response.get("access_token")

if not access_token:
    raise Exception("Could not acquire token")

headers = {
    "Authorization": f"Bearer {access_token}",
    "Accept": "application/json"
}

# Step 4: Get site ID
site_url = f"https://graph.microsoft.com/v1.0/sites/{site_hostname}:{site_path}"
site_resp = requests.get(site_url, headers=headers).json()
site_id = site_resp["id"]

# Step 5: Get all lists (with pagination support)
lists = []
next_url = f"https://graph.microsoft.com/v1.0/sites/{site_id}/lists?$top=100"

while next_url:
    resp = requests.get(next_url, headers=headers).json()
    lists.extend(resp.get("value", []))
    next_url = resp.get("@odata.nextLink")

# Step 6: Display list names
print(f"Total lists found: {len(lists)}")
for lst in lists:
    print(f"- {lst['name']} (ID: {lst['id']})")
