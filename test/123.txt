from flask import Flask, request, jsonify

app = Flask(__name__)

@app.route('/analyze-sql', methods=['POST'])
def analyze_sql():
    data = request.get_json()

    if not data or "data_sql" not in data:
        return jsonify({"error": "Missing \"data_sql\" key in JSON"}), 400

    data_sql = data["data_sql"]

    schema = data_sql.get("schema", "")
    tables = data_sql.get("tables", {})
    joins = data_sql.get("joins", "")
    where_clause = data_sql.get("where", "")

    if not tables:
        return jsonify({"error": "No tables provided"}), 400

    # Build SELECT clause
    select_fields = []
    for table, columns in tables.items():
        for col in columns:
            select_fields.append(f"{table}.{col}")
    select_clause = ", ".join(select_fields)

    # Use first table as base table
    base_table = list(tables.keys())[0]
    from_clause = f"{schema}.{base_table}" if schema else base_table

    # Build full SQL
    sql_query = f"SELECT {select_clause} FROM {from_clause}"
    if joins:
        sql_query += f" {joins}"
    if where_clause:
        sql_query += f" WHERE {where_clause}"

    return jsonify({"query": sql_query})
