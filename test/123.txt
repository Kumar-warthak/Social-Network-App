using System;
using System.IO;
using System.Net;

class Program
{
    static void Main()
    {
        string accessToken = "YOUR_ACCESS_TOKEN"; // Replace with valid token
        string url = "https://graph.microsoft.com/v1.0/sites/company.com,tenantId,siteId/lists/01234567-89ab-cdef-0123-456789abcdef/items?$expand=fields";

        GetListItemsFromGraph(url, accessToken);
    }

    static void GetListItemsFromGraph(string url, string accessToken)
    {
        try
        {
            WebRequest request = WebRequest.Create(url);
            request.Method = "GET";
            request.Headers.Add("Authorization", "Bearer " + accessToken);
            request.ContentType = "application/json";
            request.Headers.Add("Accept", "application/json");

            using (WebResponse response = request.GetResponse())
            {
                using (Stream dataStream = response.GetResponseStream())
                {
                    if (dataStream == null)
                    {
                        Console.WriteLine("No response stream received.");
                        return;
                    }

                    using (StreamReader reader = new StreamReader(dataStream))
                    {
                        string responseFromServer = reader.ReadToEnd();
                        Console.WriteLine("✅ JSON Response:");
                        Console.WriteLine(responseFromServer);
                    }
                }
            }
        }
        catch (WebException we)
        {
            using (var errorResponse = (HttpWebResponse)we.Response)
            {
                using (var reader = new StreamReader(errorResponse.GetResponseStream()))
                {
                    string errorText = reader.ReadToEnd();
                    Console.WriteLine($"❌ Error {errorResponse.StatusCode}: {errorText}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("❌ Exception: " + ex.Message);
        }
    }
}
