public List<object> GetAllAzureUsersAsObjectList(string token, string proxyUrl = null)
{
    string baseUrl = "https://graph.microsoft.com/v1.0/users?$select=id,displayName,userPrincipalName&$top=999";
    var allUsers = new List<object>();
    var serializer = new JavaScriptSerializer();

    string nextUrl = baseUrl;

    while (!string.IsNullOrEmpty(nextUrl))
    {
        HttpWebRequest request = (HttpWebRequest)WebRequest.Create(nextUrl);
        request.Method = "GET";
        request.Headers.Add("Authorization", "Bearer " + token);

        if (!string.IsNullOrEmpty(proxyUrl))
            request.Proxy = new WebProxy(proxyUrl) { Credentials = CredentialCache.DefaultCredentials };

        using (WebResponse response = request.GetResponse())
        using (StreamReader reader = new StreamReader(response.GetResponseStream()))
        {
            string json = reader.ReadToEnd();
            var parsed = serializer.Deserialize<Dictionary<string, object>>(json);

            if (parsed.ContainsKey("value"))
            {
                var users = (System.Collections.ArrayList)parsed["value"];
                foreach (var user in users)
                {
                    // Optional: remove @odata.etag if needed
                    if (user is Dictionary<string, object> userDict)
                        userDict.Remove("@odata.etag");

                    allUsers.Add(user);
                }
            }

            nextUrl = parsed.ContainsKey("@odata.nextLink") ? parsed["@odata.nextLink"].ToString() : null;
        }
    }

    return allUsers;
}
