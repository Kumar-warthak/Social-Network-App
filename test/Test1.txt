import requests
import json
import msal

# Azure AD Credentials
CLIENT_ID = "your-client-id"
CLIENT_SECRET = "your-client-secret"
TENANT_ID = "your-tenant-id"
TENANT_DOMAIN = "yourcompany.sharepoint.com"  # Replace with your actual domain
SITE_NAME = "YourSiteName"  # Example: "HRPortal"
DOCUMENT_LIBRARY_NAME = "Documents"  # Name of your document library
FILE_PATH = "path/to/your/file.txt"
UPLOAD_FILENAME = "file.txt"

# Authentication
AUTHORITY = f"https://login.microsoftonline.com/{TENANT_ID}"
GRAPH_API_URL = "https://graph.microsoft.com/v1.0"

# Get Access Token
app = msal.ConfidentialClientApplication(CLIENT_ID, CLIENT_SECRET, AUTHORITY)
token_response = app.acquire_token_for_client(scopes=["https://graph.microsoft.com/.default"])

if "access_token" not in token_response:
    print("Error obtaining token:", token_response.get("error_description"))
    exit()

ACCESS_TOKEN = token_response["access_token"]
HEADERS = {"Authorization": f"Bearer {ACCESS_TOKEN}"}

# Step 1: Get SharePoint Site ID
site_url = f"{GRAPH_API_URL}/sites/{TENANT_DOMAIN}:/sites/{SITE_NAME}?$select=id"
site_response = requests.get(site_url, headers=HEADERS)

if site_response.status_code != 200:
    print("Error fetching site ID:", site_response.text)
    exit()

SITE_ID = site_response.json()["id"]

# Step 2: Get Document Library (Drive) ID
drive_url = f"{GRAPH_API_URL}/sites/{SITE_ID}/drives"
drive_response = requests.get(drive_url, headers=HEADERS)

if drive_response.status_code != 200:
    print("Error fetching document libraries:", drive_response.text)
    exit()

# Find the correct document library by name
drive_data = drive_response.json()["value"]
DOCUMENT_LIBRARY_ID = next(
    (drive["id"] for drive in drive_data if drive["name"] == DOCUMENT_LIBRARY_NAME), None
)

if not DOCUMENT_LIBRARY_ID:
    print(f"Error: Document Library '{DOCUMENT_LIBRARY_NAME}' not found.")
    exit()

# Step 3: Upload File to Document Library
upload_url = f"{GRAPH_API_URL}/drives/{DOCUMENT_LIBRARY_ID}/root:/{UPLOAD_FILENAME}:/content"

with open(FILE_PATH, "rb") as file:
    upload_response = requests.put(upload_url, headers=HEADERS, data=file)

if upload_response.status_code in [200, 201]:
    print("File uploaded successfully:", upload_response.json()["webUrl"])
else:
    print("Error uploading file:", upload_response.text)
