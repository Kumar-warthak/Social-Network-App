Sub ApplyDynamicRules()
    Dim wsData As Worksheet, wsRules As Worksheet
    Dim lastRowData As Long, lastRowRules As Long
    Dim i As Long, j As Long
    Dim rule As String, evalRule As String
    Dim matchFound As Boolean
    Dim colHeaders As Object
    Dim cell As Range, header As String
    Dim ruleParts As Variant, part As Variant

    ' Set worksheets
    Set wsData = ThisWorkbook.Sheets("Sheet1")
    Set wsRules = ThisWorkbook.Sheets("Sheet2")

    ' Get last row of data and rules
    lastRowData = wsData.Cells(wsData.Rows.Count, 1).End(xlUp).Row
    lastRowRules = wsRules.Cells(wsRules.Rows.Count, 13).End(xlUp).Row ' Column M (13)

    ' Create a dictionary to store column names and indexes
    Set colHeaders = CreateObject("Scripting.Dictionary")
    
    ' Loop through first row (headers) in Sheet1 and store column names
    For Each cell In wsData.Rows(1).Cells
        If cell.Value <> "" Then
            colHeaders(cell.Value) = cell.Column
        End If
    Next cell

    ' Loop through each row in Sheet1
    For i = 2 To lastRowData ' Assuming row 1 has headers
        matchFound = False ' Reset match flag

        ' Loop through each rule in Sheet2 (Column M)
        For j = 1 To lastRowRules
            rule = wsRules.Cells(j, 13).Value ' Get rule from Column M
            
            ' Convert Rule into VBA-compatible format
            evalRule = rule
            
            ' Replace column names dynamically
            ruleParts = Split(evalRule, " ")
            For Each part In ruleParts
                If colHeaders.exists(part) Then
                    evalRule = Replace(evalRule, part, """" & wsData.Cells(i, colHeaders(part)).Value & """")
                End If
            Next part

            ' Fix Not Like
            evalRule = Replace(evalRule, " Not Like ", " <> ")

            ' Convert "In ()" to multiple OR conditions
            If InStr(1, evalRule, " In (") > 0 Then
                evalRule = Replace(evalRule, " In (", " = ")
                evalRule = Replace(evalRule, ")", "")
                evalRule = Replace(evalRule, ",", " Or " & wsData.Cells(i, colHeaders(part)).Address(False, False) & " = ")
            End If

            ' Debugging (Optional - Uncomment to check rule conversion)
            ' Debug.Print "Row " & i & " Rule Applied: " & evalRule
            
            ' Evaluate rule
            On Error Resume Next
            If Application.Evaluate(evalRule) Then
                ' If match found, update Column AC in Sheet1 with Column A from Sheet2
                wsData.Cells(i, 29).Value = wsRules.Cells(j, 1).Value ' Column AC = 29
                matchFound = True
                Exit For ' Stop checking further rules for this row
            End If
            On Error GoTo 0
        Next j
    Next i

    MsgBox "Rules applied successfully!", vbInformation
End Sub
